rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if authenticated user can manage a patient's data
    // Checks if user's ID is in patient's whoCareForMeIds array (simple string array)
    function canManagePatient(patientId) {
      let patientDoc = get(/databases/$(database)/documents/users/$(patientId));
      let carerIds = patientDoc.data.whoCareForMeIds;
      
      // Check if authenticated user's ID is in the whoCareForMeIds array
      // This is much simpler than checking the full whoCareForMe array of objects
      return exists(/databases/$(database)/documents/users/$(patientId)) &&
             carerIds != null &&
             request.auth.uid in carerIds;
    }
    
    // Users collection
    match /users/{userId} {
      // Allow authenticated users to search/read basic user info (for care network)
      // This allows searching by email to add people to care network
      allow read: if isAuthenticated();
      
      // Allow owner to write their own data
      allow write: if isOwner(userId);
      
      // Allow updates to iCareFor and whoCareForMe arrays when accepting invites
      // This is needed for the bidirectional care network relationship
      allow update: if isAuthenticated() && 
                      (
                        // Only updating care network fields
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['iCareFor', 'whoCareForMe']) ||
                        // Or it's the owner updating their own data
                        request.auth.uid == userId
                      );
      
      // Medications subcollection
      // Allow access if:
      // 1. User is the owner (reading/writing their own medications)
      // 2. User is a caregiver with canRegister permission
      match /medications/{medicationId} {
        allow read, write: if isOwner(userId) || 
                            (isAuthenticated() && canManagePatient(userId));
      }
      
      // Logs subcollection
      // Allow access if:
      // 1. User is the owner (reading/writing their own logs)
      // 2. User is a caregiver with canRegister permission (same as medications)
      match /logs/{logId} {
        allow read, write: if isOwner(userId) || 
                            (isAuthenticated() && canManagePatient(userId));
      }
      
      // Gamification subcollection
      // Allow access if:
      // 1. User is the owner (reading/writing their own gamification data)
      // 2. User is a caregiver (can view but not modify)
      match /gamification/{docId} {
        allow read: if isOwner(userId) || 
                      (isAuthenticated() && canManagePatient(userId));
        allow write: if isOwner(userId);
      }
      
      // Family Gamification subcollection
      // Allow access if:
      // 1. User is the owner (reading/writing their own family gamification data)
      // 2. User is a family member (in whoCareForMeIds or iCareFor)
      match /family-gamification/{docId} {
        allow read: if isOwner(userId) || 
                      (isAuthenticated() && canManagePatient(userId));
        allow write: if isOwner(userId);
      }

      // Smart Reminders - Reminder Patterns subcollection
      // Allow access if:
      // 1. User is the owner (reading/writing their own patterns)
      // 2. User is a caregiver with canManagePatient permission
      match /reminder-patterns/{patternId} {
        allow read, write: if isOwner(userId) || 
                            (isAuthenticated() && canManagePatient(userId));
      }

      // Smart Reminders - Smart Suggestions subcollection
      // Allow access if:
      // 1. User is the owner (reading/writing their own suggestions)
      // 2. User is a caregiver with canManagePatient permission
      match /smart-suggestions/{suggestionId} {
        allow read, write: if isOwner(userId) || 
                            (isAuthenticated() && canManagePatient(userId));
      }

      // Analytics subcollection (for advanced ML analysis)
      // Allow access if:
      // 1. User is the owner (reading/writing their own analytics)
      // 2. User is a caregiver (read-only)
      match /analytics/{docId} {
        allow read: if isOwner(userId) || 
                      (isAuthenticated() && canManagePatient(userId));
        allow write: if isOwner(userId);
      }

      // Subscription subcollection (read-only for users, written by system)
      match /subscription/{docId} {
        allow read: if isOwner(userId);
        allow write: if false; // Only Cloud Functions can write
      }

      // Stripe Customer subcollection
      match /stripe_customer/{docId} {
        allow read: if isOwner(userId);
        allow write: if false; // Only Cloud Functions can write
      }

      // Stripe Subscription subcollection
      match /stripe_subscription/{docId} {
        allow read: if isOwner(userId);
        allow write: if false; // Only Cloud Functions can write
      }

      // Checkout Sessions subcollection
      // Users can create checkout sessions and read their own
      match /checkout_sessions/{sessionId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if false; // Only Cloud Functions can update
      }

      // Billing Portal Sessions subcollection
      // Users can create portal sessions and read their own
      match /billing_portal_sessions/{sessionId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if false; // Only Cloud Functions can update
      }

      // PagSeguro Charges subcollection (Brazilian payments)
      // Users can create charges and read their own
      match /pagseguro_charges/{chargeId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if false; // Only Cloud Functions can update
      }
    }
    
    // Care invites collection - users can read invites sent to them or by them
    match /careInvites/{inviteId} {
      allow read: if isAuthenticated() && 
                    (resource.data.fromUserId == request.auth.uid || 
                     resource.data.toUserId == request.auth.uid);
      // Create: must be from authenticated user and cannot invite yourself
      allow create: if isAuthenticated() && 
                      request.resource.data.fromUserId == request.auth.uid &&
                      request.resource.data.fromUserId != request.resource.data.toUserId;
      allow update: if isAuthenticated() && 
                      resource.data.toUserId == request.auth.uid;
      allow delete: if isAuthenticated() && 
                      (resource.data.fromUserId == request.auth.uid || 
                       resource.data.toUserId == request.auth.uid);
    }
    
    // Terms of Use collection - authenticated users can read active terms
    match /termsOfUse/{termsId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admins can write (manage via Firebase Console)
    }

    // ============================================================================
    // ENTERPRISE COLLECTIONS
    // ============================================================================

    // Helper function to check if user is admin of organization
    function isOrgAdmin(orgId) {
      let org = get(/databases/$(database)/documents/organizations/$(orgId));
      return isAuthenticated() && request.auth.uid in org.data.adminIds;
    }

    // Helper function to check if user is team member of organization
    function isTeamMember(orgId) {
      // Query team-members collection to check if user is a member
      // Note: This is a simplified check - in production, consider caching membership
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/team-members/$(request.auth.uid + '_' + orgId));
    }

    // Helper function to get team member's role
    function getTeamRole(orgId) {
      let member = get(/databases/$(database)/documents/team-members/$(request.auth.uid + '_' + orgId));
      return member.data.role;
    }

    // Organizations collection
    match /organizations/{orgId} {
      // Read: Admins and team members
      allow read: if isOrgAdmin(orgId) || isTeamMember(orgId);
      
      // Create: Any authenticated user can create organization
      allow create: if isAuthenticated();
      
      // Update/Delete: Only admins
      allow update, delete: if isOrgAdmin(orgId);
    }

    // Team Members collection
    match /team-members/{memberId} {
      // Read: Organization admins and managers, or the member themselves
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isOrgAdmin(resource.data.organizationId)
      );
      
      // Create: Organization admins and managers
      allow create: if isAuthenticated() && 
                      isOrgAdmin(request.resource.data.organizationId);
      
      // Update: Organization admins only
      allow update: if isAuthenticated() && 
                      isOrgAdmin(resource.data.organizationId);
      
      // Delete: Organization admins only
      allow delete: if isAuthenticated() && 
                      isOrgAdmin(resource.data.organizationId);
    }

    // Audit Logs collection
    match /audit-logs/{logId} {
      // Read: Organization admins and managers
      allow read: if isAuthenticated() && 
                    isOrgAdmin(resource.data.organizationId);
      
      // Write: System only (via Cloud Functions or admin SDK)
      allow create: if isAuthenticated() && 
                      isTeamMember(request.resource.data.organizationId);
      
      allow update, delete: if false; // Audit logs are immutable
    }

    // Compliance Reports collection
    match /compliance-reports/{reportId} {
      // Read: Organization admins and managers
      allow read: if isAuthenticated() && 
                    isOrgAdmin(resource.data.organizationId);
      
      // Create: Organization admins and managers
      allow create: if isAuthenticated() && 
                      isOrgAdmin(request.resource.data.organizationId);
      
      // Update/Delete: Organization admins only
      allow update, delete: if isAuthenticated() && 
                              isOrgAdmin(resource.data.organizationId);
    }

    // API Configurations collection
    match /api-configurations/{configId} {
      // Read: Organization admins only
      allow read: if isAuthenticated() && 
                    isOrgAdmin(resource.data.organizationId);
      
      // Write: Organization admins only
      allow write: if isAuthenticated() && 
                     isOrgAdmin(request.resource.data.organizationId);
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
