<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/family-dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ 'FAMILY_NOTIFICATION_SETTINGS.TITLE' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Permissão -->
  @if (!hasPermission()) {
    <ion-card color="warning">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="notifications-outline"></ion-icon>
          Permissão Necessária
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p>Para receber notificações de doses da família, é necessário conceder permissão.</p>
        <ion-button expand="block" (click)="requestPermission()">
          <ion-icon slot="start" name="checkmark-circle"></ion-icon>
          Conceder Permissão
        </ion-button>
      </ion-card-content>
    </ion-card>
  }

  <!-- Estatísticas -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ 'FAMILY_NOTIFICATION_SETTINGS.STATISTICS' | translate }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list lines="none">
        <ion-item>
          <ion-label>
            <h3>{{ 'FAMILY_NOTIFICATION_SETTINGS.SCHEDULED_NOTIFICATIONS' | translate }}</h3>
            <p>{{ 'FAMILY_NOTIFICATION_SETTINGS.TOTAL_PENDING' | translate }}</p>
          </ion-label>
          <ion-badge slot="end" color="primary">{{ stats().pending }}</ion-badge>
        </ion-item>

        <ion-item>
          <ion-label>
            <h3>{{ 'FAMILY_NOTIFICATION_SETTINGS.TIME_GROUPS' | translate }}</h3>
            <p>{{ 'FAMILY_NOTIFICATION_SETTINGS.GROUPED_TIMES' | translate }}</p>
          </ion-label>
          <ion-badge slot="end" color="secondary">{{ stats().groupCount }}</ion-badge>
        </ion-item>

        <ion-item>
          <ion-label>
            <h3>{{ 'FAMILY_NOTIFICATION_SETTINGS.NEXT_NOTIFICATION' | translate }}</h3>
            <p>{{ formatDate(stats().nextScheduled) }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- Configurações -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ 'FAMILY_NOTIFICATION_SETTINGS.SETTINGS' | translate }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <!-- Habilitar/Desabilitar -->
        <ion-item>
          <ion-icon name="notifications-outline" slot="start"></ion-icon>
          <ion-label>
            <h3>{{ 'FAMILY_NOTIFICATION_SETTINGS.FAMILY_NOTIFICATIONS' | translate }}</h3>
            <p>{{ 'FAMILY_NOTIFICATION_SETTINGS.RECEIVE_GROUPED' | translate }}</p>
          </ion-label>
          <ion-toggle
            [checked]="config().enabled"
            (ionChange)="onEnabledChange($event)"
            [disabled]="!hasPermission()"
          ></ion-toggle>
        </ion-item>

        <!-- Som -->
        <ion-item [disabled]="!config().enabled">
          <ion-icon name="volume-medium-outline" slot="start"></ion-icon>
          <ion-label>
            <h3>{{ 'FAMILY_NOTIFICATION_SETTINGS.SOUND' | translate }}</h3>
            <p>{{ 'FAMILY_NOTIFICATION_SETTINGS.SOUND_TYPE' | translate }}</p>
          </ion-label>
          <ion-select
            [value]="config().sound"
            (ionChange)="onSoundChange($event)"
            interface="action-sheet"
          >
            <ion-select-option value="default">{{ 'FAMILY_NOTIFICATION_SETTINGS.SOUND_DEFAULT' | translate }}</ion-select-option>
            <ion-select-option value="custom">{{ 'FAMILY_NOTIFICATION_SETTINGS.SOUND_CUSTOM' | translate }}</ion-select-option>
            <ion-select-option value="silent">{{ 'FAMILY_NOTIFICATION_SETTINGS.SOUND_SILENT' | translate }}</ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Vibração -->
        <ion-item [disabled]="!config().enabled">
          <ion-icon name="phone-portrait-outline" slot="start"></ion-icon>
          <ion-label>
            <h3>{{ 'FAMILY_NOTIFICATION_SETTINGS.VIBRATION' | translate }}</h3>
            <p>{{ 'FAMILY_NOTIFICATION_SETTINGS.VIBRATE_ON_RECEIVE' | translate }}</p>
          </ion-label>
          <ion-toggle
            [checked]="config().vibrate"
            (ionChange)="onVibrateChange($event)"
          ></ion-toggle>
        </ion-item>

        <!-- Antecedência -->
        <ion-item [disabled]="!config().enabled">
          <ion-icon name="time-outline" slot="start"></ion-icon>
          <ion-label>
            <h3>{{ 'FAMILY_NOTIFICATION_SETTINGS.ADVANCE' | translate }}</h3>
            <p>{{ 'FAMILY_NOTIFICATION_SETTINGS.NOTIFY_BEFORE' | translate:{ minutes: config().timeOffsetMinutes } }}</p>
          </ion-label>
        </ion-item>

        <ion-item [disabled]="!config().enabled">
          <ion-range
            [value]="config().timeOffsetMinutes"
            (ionChange)="onTimeOffsetChange($event)"
            [min]="0"
            [max]="30"
            [step]="5"
            [pin]="true"
            [ticks]="true"
            [snaps]="true"
          >
            <ion-label slot="start">0 min</ion-label>
            <ion-label slot="end">30 min</ion-label>
          </ion-range>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- Botão Salvar -->
  <div class="save-container">
    <ion-button
      expand="block"
      (click)="saveSettings()"
      [disabled]="!hasPermission() || !config().enabled || saving()"
    >
      <ion-icon slot="start" name="save-outline"></ion-icon>
      @if (saving()) {
        Salvando...
      } @else {
        Salvar Configurações
      }
    </ion-button>
  </div>

  <!-- Informações -->
  <ion-card color="light">
    <ion-card-header>
      <ion-card-title>Como Funciona</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>
        As notificações de família agrupam todas as doses do mesmo horário em uma única notificação.
      </p>
      <p>
        <strong>Exemplo:</strong> "3 doses às 08:00 - Maria, João, Pedro"
      </p>
      <p>
        Toque na notificação para abrir o Dashboard da Família e marcar as doses.
      </p>
    </ion-card-content>
  </ion-card>
</ion-content>
